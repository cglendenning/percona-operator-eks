# Percona XtraDB Cluster Deployment

This directory contains everything needed to deploy and manage Percona XtraDB Cluster on Kubernetes.

## Contents

- `src/` - TypeScript automation tooling for Percona deployment
- `templates/` - Kubernetes manifests and Helm values
  - `chartmuseum/` - Internal Helm repository manifests
  - `litmuschaos/` - Chaos engineering resources
  - `percona-values.yaml` - Main Helm values for Percona cluster
  - `storageclass-gp3.yaml` - AWS EBS storage class definition
  - `minio-credentials-secret.yaml` - MinIO backup storage credentials
- `scripts/` - Deployment helper scripts
- `dist/` - Compiled JavaScript (generated by `npm run build`)

## Prerequisites

- Kubernetes cluster (EKS or on-premise)
- kubectl configured and authenticated
- helm 3.x installed
- Node.js 18+ (for automation tooling)

## Quick Start

### Install Percona Cluster

From the repository root:

```bash
npm run percona -- install --namespace percona --name pxc-cluster --nodes 3
```

This command will automatically:
1. Install MinIO from external repo (bootstrap component for backups)
2. Install and configure ChartMuseum (internal Helm chart repository)
3. Mirror all required charts (Percona, MinIO, LitmusChaos) to ChartMuseum
4. Install the Percona operator (from internal ChartMuseum)
5. Install the Percona cluster (from internal ChartMuseum)
6. Install LitmusChaos for chaos engineering

### Uninstall Percona Cluster

```bash
npm run percona -- uninstall --namespace percona --name pxc-cluster
```

This will automatically uninstall:
- Percona cluster and operator
- MinIO
- LitmusChaos
- ChartMuseum
- Clean up all PVCs

## Manual Script Usage

If you need to run individual components:

### ChartMuseum Setup

```bash
./percona/scripts/setup-chartmuseum.sh
```

### Mirror Charts to ChartMuseum

```bash
./percona/scripts/mirror-charts.sh
```

### Install LitmusChaos

```bash
./percona/scripts/install-litmus.sh
```

### Setup Litmus Experiments

```bash
./percona/scripts/setup-litmus-experiments.sh
```

## Configuration

### Helm Values

The main configuration is in `templates/percona-values.yaml`. Key settings:

- **PXC nodes**: Number of database nodes (default: 3)
- **Storage class**: EKS uses `gp3`, on-prem needs custom configuration
- **Backup configuration**: MinIO S3-compatible storage
- **Proxy**: ProxySQL or HAProxy (default: HAProxy)
- **Resources**: CPU/memory requests and limits

### Internal Helm Repository

By default, the installation uses ChartMuseum as an internal Helm repository to mirror on-premises environments where external access may be restricted. This provides:

- **Air-gapped support**: All charts stored internally
- **Version control**: Pin specific chart versions
- **Resilience**: No dependency on external repositories during deployment

## Architecture

### Components

1. **Percona Operator**: Manages PerconaXtraDBCluster custom resources
2. **PXC Nodes**: StatefulSet with 3 nodes (configurable)
3. **ProxySQL/HAProxy**: Load balancer and connection pooling
4. **MinIO**: S3-compatible backup storage
5. **ChartMuseum**: Internal Helm chart repository
6. **LitmusChaos**: Chaos engineering for resiliency testing

### Multi-AZ Deployment (EKS)

- PXC nodes distributed across 3 availability zones
- Anti-affinity rules prevent co-location
- Zone-aware topology keys for scheduling

### On-Premise Deployment

- Anti-affinity based on `kubernetes.io/hostname`
- Configurable storage classes
- No AWS-specific dependencies

## Backup Configuration

MinIO is used for backups to replicate on-premises environments. Backups are configured via:

- **Bucket**: `percona-backups` (auto-created)
- **Schedule**: Defined in `percona-values.yaml`
- **Credentials**: Stored in Kubernetes secrets

## Troubleshooting

### Check Operator Status

```bash
kubectl get pods -n percona
kubectl logs -n percona -l app.kubernetes.io/name=percona-xtradb-cluster-operator
```

### Check Cluster Status

```bash
kubectl get pxc -n percona
kubectl describe pxc pxc-cluster -n percona
```

### Check ChartMuseum

```bash
kubectl get pods -n chartmuseum
kubectl port-forward -n chartmuseum svc/chartmuseum 8080:8080
curl http://localhost:8080/api/charts
```

### Check MinIO

```bash
kubectl get pods -n minio
kubectl logs -n minio -l app.kubernetes.io/name=minio
```

## Development

### Build TypeScript

```bash
npm run build
```

This compiles `src/*.ts` to `dist/*.js`.

### Modify Helm Values

Edit `templates/percona-values.yaml` and reinstall:

```bash
npm run percona -- uninstall --namespace percona --name pxc-cluster
npm run percona -- install --namespace percona --name pxc-cluster --nodes 3
```

